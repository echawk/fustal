#!/bin/sh -ex

case "$(uname)" in
    Linux)  host=linux   ext=tar.xz;;
    Darwin) host=macos   ext=tar.xz;;
    MINGW*) host=windows ext=zip;;
esac

FUTHARK_TARBALL="https://github.com/diku-dk/futhark/releases/download/nightly/futhark-nightly-$host-x86_64.$ext"

# Setup futhark
mkdir -p .futhark
if [ -e .futhark ]; then
    cd .futhark
    file="$(echo "$FUTHARK_TARBALL" | rev | cut -d'/' -f1 | rev)"
    if ! [ -e "$file" ]; then
        curl -LO "$FUTHARK_TARBALL"
    fi
    case $ext in
        tar.xz) tar xvf "$file";;
        zip)    unzip "$file";;
    esac
    cd "$OLDPWD"
fi

# Setup Python
if ! [ -e .venv ]; then
    python3 -m venv .venv
fi
. .venv/bin/activate
pip install -r requirements.txt

cat > .env << EOF
export PATH="$PWD/.futhark/futhark-nightly-linux-x86_64/bin/:$PATH"
. .venv/bin/activate
EOF

cat << EOF
[INFO]: To use the installed software, run the following in your shell:

$ . .env

EOF

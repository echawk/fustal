#!/bin/sh -e

# Check environment for needed software.

for cmd in futhark build_futhark_ffi; do
    if ! command -v "$cmd"; then
        echo "[ERR]: $cmd is not available on this system."; exit 1
    fi
done

FUTHARK_TARGET="${FUTHARK_TARGET:-c}"

BUILD_DOCS="${BUILD_DOCS:-0}"

case $FUTHARK_TARGET in
cuda)
    for l in cuda cudart; do
        export CFLAGS="$CFLAGS $(pkg-config --cflags $l)"
        export CFLAGS="$CFLAGS $(pkg-config --libs $l)"
    done
    ;;
esac

# TODO: add cleaning step
[ -d output ] && rm -rf output
mkdir output
echo "$FUTHARK_TARGET" >> output/futhark_target
cp -a src/* output
sh ./utils/gendocs >output/doc.tex 2>/dev/null
cd output
futhark pkg sync
futhark "$FUTHARK_TARGET" --library fustal.fut
build_futhark_ffi fustal
# Try to build both PDF and HTML versions of the documentation.
if command -v latexmk && command -v make4ht && [ "$BUILD_DOCS" = 1 ]; then
    latexmk -pdf doc.tex
    make4ht doc.tex "mathjax"
fi
